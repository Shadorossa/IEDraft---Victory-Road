<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Inazuma Draft - Ultra Smooth Final V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="data.js" onerror="console.log('Modo manual activo')"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Orbitron:wght@500;700;900&display=swap');

        :root {
            --bg-dark: #0a0a0a;
            --bg-panel: rgba(20, 20, 20, 0.95);
            --accent-gold: #c5a059;
            --accent-gold-bright: #f1c40f;
            --text-main: #ecf0f1;

            /* RAREZAS */
            --c-if-border: #f1c40f;
            --c-if-bg: #000;
            --c-if-text: #f1c40f;
            --c-if-shadow: rgba(241, 196, 15, 0.6);
            --c-gold-s-border: #f9e79f;
            --c-gold-s-bg: linear-gradient(135deg, #8a6e2f, #d4ac0d);
            --c-gold-border: #705b2e;
            --c-gold-bg: #362e1e;
            --c-silver-s-border: #a0a0a0;
            --c-silver-s-bg: linear-gradient(135deg, #7f8c8d, #bdc3c7);
            --c-silver-border: #444;
            --c-silver-bg: #1c1c1c;
            --stat-low: #e74c3c;
            --stat-mid: #f39c12;
            --stat-high: #2ecc71;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1f1f1f 0%, #000 80%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        /* UI CONFIG */
        #config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 9000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .config-box {
            background: #111;
            border: 1px solid #444;
            padding: 50px;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(197, 160, 89, 0.1);
            text-align: center;
            width: 500px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .config-title {
            font-family: 'Orbitron';
            font-size: 2rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        .config-select {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 15px;
            font-size: 1.2rem;
            font-family: 'Orbitron';
            width: 100%;
            text-align: center;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .config-select:hover {
            border-color: var(--accent-gold);
        }

        .preview-pitch {
            width: 200px;
            height: 260px;
            background: #1a1a1a;
            border: 2px solid #444;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            padding: 10px;
        }

        .preview-row {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .preview-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #666;
        }

        .preview-row:last-child .preview-dot {
            background: var(--accent-gold);
            border-color: var(--accent-gold-bright);
        }

        .btn-start {
            background: var(--accent-gold);
            color: #000;
            font-family: 'Orbitron';
            font-weight: 900;
            font-size: 1.2rem;
            padding: 15px 40px;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.2s;
        }

        .btn-start:hover {
            background: var(--accent-gold-bright);
            transform: scale(1.02);
        }

        /* HEADER */
        header {
            width: 100%;
            height: 80px;
            background: #0f0f0f;
            border-bottom: 1px solid #333;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 0 50px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            font-weight: 800;
            font-style: italic;
            text-transform: uppercase;
            font-size: 2rem;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .controls-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .info-pill {
            font-family: 'Orbitron';
            font-size: 1rem;
            padding: 8px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-pill strong {
            color: #fff;
            font-size: 1.2rem;
        }

        .info-pill.power strong {
            color: var(--accent-gold-bright);
        }

        button.btn-small {
            background: #222;
            border: 1px solid #444;
            color: #ccc;
            padding: 8px 20px;
            font-family: 'Chakra Petch';
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }

        button.btn-small:hover {
            background: #eee;
            color: #000;
        }

        button.btn-photo {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        button.btn-photo:hover {
            background: var(--accent-gold);
            color: #000;
        }

        /* PITCH */
        #main-layout {
            display: none;
            align-items: flex-start;
            justify-content: center;
            gap: 40px;
            padding: 40px;
            width: fit-content;
        }

        .pitch-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .pitch {
            width: 950px;
            height: 850px;
            background-color: #1a3c22;
            background-image: linear-gradient(rgba(0, 0, 0, 0.15) 2px, transparent 2px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px), radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.6) 100%);
            background-size: 100% 85px, 85px 100%, 100% 100%;
            border: 5px solid #ccc;
            box-shadow: 0 10px 60px rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            padding: 20px 0;
            overflow: hidden;
        }

        .pitch-lines-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .field-line-box {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .penalty-area {
            width: 55%;
            height: 16%;
        }

        .penalty-area.top {
            top: 0;
            border-top: none;
        }

        .penalty-area.bottom {
            bottom: 0;
            border-bottom: none;
        }

        .goal-area {
            width: 26%;
            height: 6%;
        }

        .goal-area.top {
            top: 0;
            border-top: none;
        }

        .goal-area.bottom {
            bottom: 0;
            border-bottom: none;
        }

        .pitch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            z-index: 1;
        }

        .pitch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .field-row {
            display: flex;
            justify-content: center;
            gap: 60px;
            position: relative;
            z-index: 10;
        }

        /* --- SLOTS (MINI CARDS) SMOOTH FIX --- */
        .slot {
            width: 130px;
            height: 185px;
            background: rgba(15, 15, 15, 0.95);
            border: 1px solid #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            z-index: 5;

            /* Hardware Acceleration & Initial State */
            transform: translateZ(0) scale(1) translateY(0) skewX(-3deg);
            backface-visibility: hidden;
            -webkit-font-smoothing: subpixel-antialiased;

            /* Transición fluida */
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
                box-shadow 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
                border-color 0.3s ease,
                background-color 0.3s ease;

            will-change: transform;
        }

        .slot:not(.filled) {
            animation: pulse-border-charge 2s infinite;
        }

        @keyframes pulse-border-charge {
            0% {
                border-color: #333;
            }

            50% {
                border-color: #666;
                background: rgba(30, 30, 30, 0.9);
            }

            100% {
                border-color: #333;
            }
        }

        .slot:hover {
            transform: translateZ(0) scale(1.1) translateY(-10px) skewX(-3deg) !important;
            z-index: 100;
            border-color: #fff;
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.8);
        }

        .slot.filled {
            border-width: 2px;
            border-style: solid;
            animation: none;
        }

        .slot.filled.s-if {
            background: var(--c-if-bg);
            border-color: var(--c-if-border);
            box-shadow: 0 0 20px var(--c-if-shadow);
        }

        .slot.filled.s-if .mini-name {
            color: var(--c-if-text);
        }

        .slot.filled.s-gold-s {
            background: var(--c-gold-s-bg);
            border-color: var(--c-gold-s-border);
            box-shadow: 0 0 15px rgba(212, 172, 13, 0.4);
        }

        .slot.filled.s-gold-s .mini-name {
            color: #3d3000;
            text-shadow: none;
        }

        .slot.filled.s-gold {
            background: var(--c-gold-bg);
            border-color: var(--c-gold-border);
        }

        .slot.filled.s-silver-s {
            background: var(--c-silver-s-bg);
            border-color: var(--c-silver-s-border);
            box-shadow: none;
        }

        .slot.filled.s-silver-s .mini-name {
            color: #222;
            text-shadow: none;
        }

        .slot.filled.s-silver {
            background: var(--c-silver-bg);
            border-color: var(--c-silver-border);
            box-shadow: none;
        }

        .pos-label {
            font-size: 2.2rem;
            color: rgba(255, 255, 255, 0.1);
            font-weight: 900;
            font-family: 'Orbitron';
            pointer-events: none;
            font-style: italic;
        }

        .mini-player {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* --- CAMBIOS SOLICITADOS EN MINI CARTA (POSICIÓN ALTA) --- */

        .mini-img {
            width: 120%;
            /* Mantiene el ancho para que se salga un poco por los lados */
            height: 85%;
            /* Altura reducida: la imagen no llega hasta abajo del todo */
            object-fit: contain;
            object-position: center;
            /* Centra la imagen dentro de su caja de altura reducida */
            position: absolute;
            top: 8%;
            /* La bajamos un poco del borde superior */
            left: -10%;
            /* Eliminamos bottom: 0 para que no se ancle abajo */

            filter: drop-shadow(0 5px 8px rgba(0, 0, 0, 0.6));

            /* Ajustamos la máscara: el degradado empieza antes (60%) y termina casi al final de la caja de la imagen (98%) */
            /* Esto hace que los pies se vuelvan transparentes "en el aire" antes de que acabe la carta */
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 98%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 98%);

            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s;
            transform: translateZ(0);
            opacity: 0;
            z-index: 1;
        }

        .mini-img.loaded {
            opacity: 1;
        }

        .slot.filled:hover .mini-img {
            transform: scale(1.1) translateZ(0);
        }

        .mini-info {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: auto;
            padding-bottom: 8px;
            padding-top: 15px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            z-index: 2;
            pointer-events: none;
        }

        .mini-info::before {
            display: none;
        }

        .mini-name {
            font-size: 0.75rem;
            color: #fff;
            font-weight: 800;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 90%;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 2px rgba(0, 0, 0, 1);
            z-index: 3;
        }

        .mini-total {
            font-family: 'Orbitron';
            font-size: 0.85rem;
            margin-top: 0px;
            font-weight: 900;
            font-style: italic;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 2px rgba(0, 0, 0, 1);
            z-index: 3;
        }

        /* ----------------------------------------- */

        .mini-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #222;
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #555;
            z-index: 5;
            font-weight: 900;
            font-family: 'Orbitron';
        }

        /* SIDEBAR */
        #sidebar-wrapper {
            display: flex;
            gap: 30px;
            background: var(--bg-panel);
            padding: 35px;
            border-radius: 15px;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        .sidebar-title {
            font-family: 'Orbitron';
            color: #fff;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.2rem;
            border-bottom: 1px solid #555;
            width: 100%;
            font-weight: 900;
            font-style: italic;
        }

        .bench-column,
        .staff-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .slot.bench-card {
            width: 100px;
            height: 140px;
        }

        .slot.bench-card .pos-label {
            font-size: 1.5rem;
        }

        .slot.big-boss {
            width: 150px;
            height: 210px;
            border: 1px solid #fff;
            margin-bottom: 25px;
        }

        /* RESERVAS */
        #reserves-section {
            width: 950px;
            background: #151515;
            border-top: 2px solid #444;
            border-radius: 0 0 15px 15px;
            padding: 20px 25px;
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: -15px;
            z-index: 20;
            position: relative;
        }

        .reserves-title {
            font-family: 'Orbitron';
            color: #888;
            font-size: 1rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            width: 100%;
            text-align: left;
            font-weight: 900;
            font-style: italic;
        }

        .reserves-grid {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
        }

        .reserve-slot {
            width: 85px;
            height: 115px;
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: 0.3s;
            flex-shrink: 0;
        }

        .reserve-slot.s-if {
            border: 1px solid var(--c-if-border);
            background: #111;
        }

        .reserve-slot.s-gold-s {
            border: 1px solid var(--c-gold-s-border);
            background: #3d3000;
        }

        .reserve-slot.s-gold {
            border: 1px solid var(--c-gold-border);
            background: #2b2515;
        }

        .reserve-slot.s-silver-s {
            border: 1px solid var(--c-silver-s-border);
            background: #333;
        }

        .reserve-slot:hover {
            transform: translateY(-5px);
        }

        .reserve-pos {
            position: absolute;
            top: 3px;
            right: 3px;
            font-size: 0.6rem;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            z-index: 2;
            font-family: 'Orbitron';
        }

        .reserve-img {
            width: 110%;
            height: 80%;
            object-fit: contain;
            object-position: bottom;
            position: absolute;
            bottom: 20%;
            filter: grayscale(0.5);
            opacity: 0;
            transition: opacity 0.5s;
        }

        .reserve-img.loaded {
            opacity: 1;
        }

        .reserve-slot:hover .reserve-img {
            filter: grayscale(0);
        }

        .reserve-name-box {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 24%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .reserve-name {
            font-size: 0.6rem;
            color: #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 95%;
            text-align: center;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            width: 95%;
            max-width: 1400px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .modal-content.god-pack {
            border-color: var(--accent-gold-bright);
            box-shadow: 0 0 50px rgba(241, 196, 15, 0.1);
        }

        .modal-header {
            padding: 25px 40px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #modalTitle {
            font-family: 'Orbitron';
            font-weight: 900;
            font-style: italic;
            font-size: 2rem;
            color: #fff;
        }

        .modal-grid {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 30px;
            padding: 60px 30px;
            overflow-x: hidden;
            align-items: center;
            background: radial-gradient(circle, #252525 0%, #1a1a1a 100%);
            min-height: 400px;
        }

        /* --- PACK ANIMATION SOFT --- */
        #pack-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.98);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.2s;
            perspective: 1000px;
        }

        .pack-visual {
            width: 240px;
            height: 350px;
            border: 4px solid #fff;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: shake-fast 0.3s infinite ease-in-out;
        }

        /* COLORES DINAMICOS */
        .pack-visual.p-god {
            background: linear-gradient(135deg, #bf953f, #fcf6ba, #aa771c);
            box-shadow: 0 0 80px rgba(255, 223, 0, 0.5);
            border-color: #fffce0;
        }

        .pack-visual.p-gold {
            background: linear-gradient(135deg, #8a6e2f, #f1c40f, #8a6e2f);
            box-shadow: 0 0 50px rgba(241, 196, 15, 0.3);
        }

        .pack-visual.p-silver {
            background: linear-gradient(135deg, #7f8c8d, #ecf0f1, #95a5a6);
            box-shadow: 0 0 50px rgba(189, 195, 199, 0.3);
            border-color: #e0e0e0;
        }

        .pack-visual.p-bronze {
            background: linear-gradient(135deg, #5d4037, #a1887f, #6d4c41);
            box-shadow: 0 0 50px rgba(211, 84, 0, 0.3);
            border-color: #a07c70;
        }

        .pack-visual::before {
            content: "INAZUMA";
            font-family: 'Orbitron';
            font-weight: 900;
            font-style: italic;
            color: rgba(0, 0, 0, 0.6);
            font-size: 1.8rem;
            position: relative;
            z-index: 2;
        }

        .pack-visual.opening {
            animation: dramatic-open-flash 0.6s forwards cubic-bezier(0.6, 0.04, 0.98, 0.335);
        }

        @keyframes shake-fast {

            0%,
            100% {
                transform: rotate(0deg) scale(1);
            }

            50% {
                transform: rotate(3deg) scale(1.02);
            }
        }

        @keyframes dramatic-open-flash {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4) rotateX(10deg);
                filter: brightness(1.2);
            }

            100% {
                transform: scale(4);
                opacity: 0;
                filter: brightness(2);
            }
        }

        /* TRANSICION SUAVE (NO FLASHBANG) */
        .pack-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 200, 0.3) 0%, transparent 70%);
            z-index: 300;
            opacity: 0;
            pointer-events: none;
        }

        .pack-flash.active {
            animation: soft-reveal 0.5s forwards ease-out;
        }

        @keyframes soft-reveal {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        /* --- ZOOM CARD ULTRA SMOOTH FIX --- */
        .choice-card {
            background: #252525;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 230px;
            height: 340px;
            flex-shrink: 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;

            /* HARDWARE ACCELERATION + ESTADO INICIAL */
            transform: translateZ(0) scale(1) translateY(0) skewX(-2deg);
            backface-visibility: hidden;
            /* Clave para evitar vibración en texto */
            -webkit-font-smoothing: subpixel-antialiased;

            /* Transición más larga (0.6s) y curva más relajada */
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1),
                box-shadow 0.6s cubic-bezier(0.19, 1, 0.22, 1),
                border-color 0.4s ease;
            will-change: transform;
        }

        .choice-card:hover {
            /* Movimiento más sutil y seguro */
            transform: translateZ(0) scale(1.08) translateY(-12px) skewX(-2deg) !important;

            z-index: 100;
            box-shadow: 0 30px 50px rgba(0, 0, 0, 0.8);
            border-color: #fff;
        }

        .choice-card.revealed {
            animation: revealCard 0.3s forwards ease-out;
        }

        @keyframes revealCard {
            to {
                opacity: 1;
                /* Match the base state */
                transform: translateZ(0) scale(1) translateY(0) skewX(-2deg);
            }

            from {
                opacity: 0;
                transform: translateZ(0) scale(0.9) translateY(50px) skewX(-5deg);
            }
        }

        /* ... RESTO DE ESTILOS ... */
        .choice-card.s-if {
            border: 2px solid var(--c-if-border);
            background: var(--c-if-bg);
            box-shadow: 0 0 40px var(--c-if-shadow);
        }

        .choice-card.s-gold-s {
            border: 2px solid var(--c-gold-s-border);
            background: var(--c-gold-s-bg);
            box-shadow: 0 0 30px rgba(212, 172, 13, 0.3);
        }

        .choice-card.s-gold {
            border: 2px solid var(--c-gold-border);
            background: var(--c-gold-bg);
        }

        .choice-card.s-silver-s {
            border: 2px solid var(--c-silver-s-border);
            background: var(--c-silver-s-bg);
        }

        .choice-card.s-silver {
            border: 2px solid var(--c-silver-border);
            background: var(--c-silver-bg);
        }

        .choice-img-box {
            height: 190px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .choice-img {
            height: 95%;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.8));
            z-index: 2;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .choice-img.loaded {
            opacity: 1;
        }

        .choice-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
        }

        .choice-name {
            font-size: 1.1rem;
            color: #fff;
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Orbitron';
            font-style: italic;
        }

        .choice-card.s-gold-s .choice-name,
        .choice-card.s-silver-s .choice-name {
            color: #222;
            border-color: rgba(0, 0, 0, 0.2);
        }

        .choice-card.s-if .choice-name {
            color: var(--c-if-text);
        }

        .choice-score {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #222;
            border: 1px solid #555;
            color: #fff;
            padding: 5px 12px;
            font-family: 'Orbitron';
            font-weight: 900;
            font-size: 1.2rem;
            border-radius: 4px;
            z-index: 10;
            font-style: italic;
        }

        .choice-card.s-if .choice-score {
            color: var(--c-if-text);
            border-color: var(--c-if-border);
            background: #000;
        }

        /* STATS MAS LEGIBLES */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px;
            font-size: 0.8rem;
            color: #fff;
            /* Texto blanco siempre */
            font-weight: 700;
            /* Negrita */
            text-shadow: 0 0 3px #000, 1px 1px 2px #000;
            /* Sombra negra fuerte */
        }

        /* Eliminar override de color para cartas claras, mantener blanco+sombra para contraste universal */
        .choice-card.s-gold-s .stats-grid,
        .choice-card.s-silver-s .stats-grid {
            color: #fff;
            text-shadow: 0 0 3px #000, 1px 1px 2px #000;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .el-Fuego {
            color: #ff5252;
            text-shadow: 1px 1px 1px #000;
        }

        .el-Viento {
            color: #00b8e6;
            text-shadow: 1px 1px 1px #000;
        }

        .el-Bosque {
            color: hwb(108 5% 24%);
            text-shadow: 1px 1px 1px #000;
        }

        .el-Montaña {
            color: #ffb300;
            text-shadow: 1px 1px 1px #000;
        }

        .el-Neutro {
            color: #e040fb;
            text-shadow: 1px 1px 1px #000;
        }

        #manual-load {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div id="manual-load" style="display: none;">
        <h2 style="color:var(--accent-gold); font-family:'Orbitron'">CARGA DE BASE DE DATOS</h2>
        <input type="file" id="jsonFile" accept=".json"
            style="margin-top:20px; color:#fff; background:#222; padding:10px; border:1px solid #555;">
    </div>

    <div id="config-overlay">
        <div class="config-box">
            <div class="config-title">SYSTEM START</div>
            <div style="text-align: left; width: 100%;">
                <label
                    style="color:#888; font-size:0.8rem; margin-bottom:8px; display:block; text-transform:uppercase; letter-spacing:1px;">Seleccionar
                    Táctica</label>
                <select id="formationInput" class="config-select"></select>
            </div>
            <div id="formation-preview" class="preview-pitch"></div>
            <button class="btn-start" onclick="startGame()">INICIAR DRAFT</button>
        </div>
    </div>

    <header id="main-header">
        <h1>VICTORY ROAD</h1>
        <div class="controls-group">
            <div class="info-pill">TÁCTICA: <strong id="displayFormation">4-4-2</strong></div>
            <div class="info-pill power">PODER: <strong id="team-power">0</strong></div>
            <button class="btn-small" onclick="resetDraft()">REINICIAR</button>
            <button class="btn-small btn-photo" onclick="takeScreenshot()">FOTO</button>
        </div>
    </header>

    <div id="main-layout">
        <div class="pitch-wrapper">
            <div class="pitch" id="pitchBoard">
                <div class="pitch-lines-container">
                    <div class="field-line-box penalty-area top"></div>
                    <div class="field-line-box penalty-area bottom"></div>
                    <div class="field-line-box goal-area top"></div>
                    <div class="field-line-box goal-area bottom"></div>
                </div>
            </div>
            <div id="reserves-section">
                <div class="reserves-title">LISTA DE SUSTITUTOS</div>
                <div id="reserves-container" class="reserves-grid"></div>
            </div>
        </div>

        <div id="sidebar-wrapper">
            <div class="bench-column">
                <div class="sidebar-title">BANQUILLO</div>
                <div id="benchBoard" style="display: flex; flex-direction: column; gap: 15px;"></div>
            </div>
            <div class="staff-column">
                <div class="sidebar-title">STAFF TÉCNICO</div>
                <div id="staff-container">
                    <div id="manager-slot-area"></div>
                    <div class="bench-row" id="coordinators-row" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="draftModal">
        <div class="modal-content" id="modalBox">
            <div id="pack-loader">
                <div class="pack-visual" id="packVisual"></div>
            </div>
            <div class="pack-flash" id="packFlash"></div>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
            </div>
            <div class="modal-grid" id="modalOptions"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE RATES (PROBABILIDADES) ---
        const DRAFT_CONFIG = {
            normal: {
                IF: 0.5,          // 0.5% Probabilidad Inazuma Future
                GoldShiny: 5.0,   // 5.0% Probabilidad Dorado Brillante
                Gold: 20.0,       // 20.0% Probabilidad Dorado Normal
                SilverShiny: 50.0 // 50.0% Probabilidad Plateado Brillante
                // El resto (aprox 24.5%) será Plata Normal / Bronce
            },
            godPack: {
                IF: 10.0          // 10% IF, el 90% restante será Gold Shiny
            }
        };

        let database = [];
        let pickedIDs = new Set();
        let pickedBaseNames = new Set();
        let currentFormation = "4-4-2";
        let teamTotal = 0;

        let limitIF = 0;
        let limitGoldShiny = 0;
        let limitGold = 0;
        let limitSilverShiny = 0;

        let specialSlotIndices = new Set();
        let currentSlotIndex = 0;

        const pathCache = new Map();

        const translations = {
            pos: { "GK": "Portero", "DF": "Defensa", "MF": "Mediocampista", "FW": "Delantero", "Player": "Jugador", "Manager": "Entrenador", "Coordinator": "Gerente" },
            elem: { "Fire": "Fuego", "Wind": "Viento", "Mountain": "Montaña", "Forest": "Bosque", "Void": "Neutro" }
        };

        const formations = {
            "4-4-2": [["FW", "FW"], ["MF", "MF", "MF", "MF"], ["DF", "DF", "DF", "DF"], ["GK"]],
            "3-5-2": [["FW", "FW"], ["MF", "MF", "MF", "MF", "MF"], ["DF", "DF", "DF"], ["GK"]],
            "4-3-3": [["FW", "FW", "FW"], ["MF", "MF", "MF"], ["DF", "DF", "DF", "DF"], ["GK"]],
            "4-5-1": [["FW"], ["MF", "MF", "MF", "MF", "MF"], ["DF", "DF", "DF", "DF"], ["GK"]],
            "3-6-1": [["FW"], ["MF", "MF", "MF", "MF", "MF", "MF"], ["DF", "DF", "DF"], ["GK"]],
            "5-4-1": [["FW"], ["MF", "MF", "MF", "MF"], ["DF", "DF", "DF", "DF", "DF"], ["GK"]]
        };

        const baseSeasons = ['IE1', 'IE2', 'IE3', 'IEGO', 'GOCS', 'GOGX', 'ARES', 'ORION', 'VICTORY ROAD'];

        // --- PRE-LOADER INTELIGENTE ---
        function findValidPath(id, name) {
            return new Promise((resolve) => {
                if (pathCache.has(id)) {
                    resolve(pathCache.get(id));
                    return;
                }

                const nameClean = name.split('(')[0].trim().replace(/[^a-zA-Z0-9]/g, '');
                const id4 = String(id).padStart(4, '0');
                const fileName = `${id4}_${nameClean}.png`;

                let candidates = [];
                baseSeasons.forEach(season => {
                    candidates.push(`img/${season}/Scouts/${fileName}`);
                    candidates.push(`img/${season}/${fileName}`);
                });

                let solved = false;
                let pending = candidates.length;

                candidates.forEach(src => {
                    const img = new Image();
                    img.onload = () => {
                        if (!solved) {
                            solved = true;
                            pathCache.set(id, src);
                            resolve(src);
                        }
                    };
                    img.onerror = () => {
                        pending--;
                        if (pending === 0 && !solved) resolve(null);
                    };
                    img.src = src;
                });
            });
        }

        window.loadKnownImage = function (img, id, name) {
            findValidPath(id, name).then(src => {
                if (src) {
                    img.src = src;
                    img.classList.add('loaded'); // Asegurar que se ve
                }
                else img.style.opacity = '0.3';
            });
        };

        function getSafeName(name) {
            let str = name.toLowerCase();
            return str.replace(/[^a-z0-9]/g, '');
        }

        function getBaseName(name) {
            return name.split('(')[0].trim().toLowerCase();
        }

        window.onload = () => {
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('main-layout').style.display = 'none';
            document.getElementById('config-overlay').style.display = 'flex';

            const formSelect = document.getElementById('formationInput');
            Object.keys(formations).forEach(f => {
                const opt = document.createElement('option');
                opt.value = f; opt.innerText = f;
                formSelect.appendChild(opt);
            });

            formSelect.addEventListener('change', (e) => updatePreview(e.target.value));
            updatePreview(formSelect.value);

            if (typeof INAZUMA_DATA !== 'undefined') {
                database = INAZUMA_DATA;
                onDataLoaded();
            } else {
                document.getElementById('manual-load').style.display = 'flex';
            }
            document.getElementById('jsonFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { database = JSON.parse(ev.target.result); document.getElementById('manual-load').style.display = 'none'; onDataLoaded(); } catch (err) { alert("JSON inválido"); }
                };
                reader.readAsText(file);
            });
        };

        function updatePreview(formationName) {
            const container = document.getElementById('formation-preview');
            container.innerHTML = '';
            const layout = formations[formationName];
            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'preview-row';
                row.forEach(() => {
                    const dot = document.createElement('div');
                    dot.className = 'preview-dot';
                    rowDiv.appendChild(dot);
                });
                container.appendChild(rowDiv);
            });
        }

        function startGame() {
            const selector = document.getElementById('formationInput');
            currentFormation = selector.value;
            document.getElementById('displayFormation').innerText = currentFormation;
            document.getElementById('config-overlay').style.display = 'none';
            document.getElementById('main-header').style.display = 'flex';
            document.getElementById('main-layout').style.display = 'flex';
            initDraft();
        }

        function onDataLoaded() { calculateThresholds(); }

        function calculateThresholds() {
            let minTot = Infinity, maxTot = -Infinity;
            database.forEach(p => {
                let t = calcTotal(p);
                if (t > 0) {
                    if (t < minTot) minTot = t;
                    if (t > maxTot) maxTot = t;
                }
            });
            if (minTot === Infinity) { minTot = 0; maxTot = 600; }

            limitIF = maxTot;
            let rT = maxTot - minTot;
            limitGoldShiny = minTot + (rT * 0.85);
            limitGold = minTot + (rT * 0.60);
            limitSilverShiny = minTot + (rT * 0.35);
        }

        function getTotalColorClass(val) {
            if (val >= limitIF) return 's-if';
            if (val >= limitGoldShiny) return 's-gold-s';
            if (val >= limitGold) return 's-gold';
            if (val >= limitSilverShiny) return 's-silver-s';
            return 's-silver';
        }

        function generateSpecialSlots() {
            specialSlotIndices.clear();
            const numSpecials = Math.floor(Math.random() * 4) + 1;
            while (specialSlotIndices.size < numSpecials) {
                let rand = Math.floor(Math.random() * 20);
                specialSlotIndices.add(rand);
            }
        }

        function initDraft() {
            if (!database.length) return;
            const pitch = document.getElementById('pitchBoard');
            pitch.innerHTML = `
                <div class="pitch-lines-container">
                    <div class="field-line-box penalty-area top"></div>
                    <div class="field-line-box penalty-area bottom"></div>
                    <div class="field-line-box goal-area top"></div>
                    <div class="field-line-box goal-area bottom"></div>
                </div>
            `;

            teamTotal = 0; updateStats();
            pickedIDs.clear();
            pickedBaseNames.clear();
            document.getElementById('reserves-section').style.display = 'none';
            document.getElementById('reserves-container').innerHTML = '';
            generateSpecialSlots();
            currentSlotIndex = 0;

            formations[currentFormation].forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'field-row';
                row.forEach(pos => createSlot(rowDiv, pos, "Player", true, false));
                pitch.appendChild(rowDiv);
            });

            const bench = document.getElementById('benchBoard'); bench.innerHTML = "";
            for (let i = 0; i < 5; i++) createSlot(bench, "Player", "Player", false, true);

            const managerArea = document.getElementById('manager-slot-area');
            managerArea.innerHTML = "";
            createSlot(managerArea, "Manager", "Manager", true, true, true);

            const coordinatorsRow = document.getElementById('coordinators-row');
            coordinatorsRow.innerHTML = "";
            for (let i = 0; i < 3; i++) createSlot(coordinatorsRow, "Coordinator", "Coordinator", true, true);
        }

        function createSlot(parent, posCode, role, strict, isBench, isBigBoss = false) {
            const slot = document.createElement('div');
            let classes = `slot`;
            if (isBench) classes += ' bench-card';
            if (isBigBoss) classes += ' big-boss';
            const isSpecial = specialSlotIndices.has(currentSlotIndex);
            if (isSpecial) classes += ' god-ready';
            currentSlotIndex++;

            slot.className = classes;
            let label = posCode;
            if (posCode === 'Player') label = 'RES'; if (posCode === 'Coordinator') label = 'GER'; if (posCode === 'Manager') label = 'ENT';
            slot.innerHTML = `<div class="pos-label">${label}</div>`;

            slot.onclick = () => {
                if (slot.classList.contains('filled')) return;
                openModal(slot, posCode, role, strict, isSpecial);
            };
            parent.appendChild(slot);
        }

        let activeSlot = null;
        async function openModal(slot, posCode, role, strict, isSpecial) {
            activeSlot = slot;
            const modal = document.getElementById('draftModal');
            const modalBox = document.getElementById('modalBox');
            const container = document.getElementById('modalOptions');
            const title = document.getElementById('modalTitle');
            const loader = document.getElementById('pack-loader');
            const packVisual = document.getElementById('packVisual');
            const flash = document.getElementById('packFlash');

            modal.style.display = 'flex';
            container.innerHTML = '';

            // 1. MOSTRAR SOBRE ANIMADO
            loader.style.display = 'flex';
            loader.style.opacity = '1';
            flash.classList.remove('active');
            packVisual.className = 'pack-visual';

            // Scroll oculto durante animacion
            const grid = document.querySelector('.modal-grid');
            if (grid) grid.style.overflowX = 'hidden';

            title.innerText = (translations.pos[posCode] || posCode);

            if (isSpecial) modalBox.classList.add('god-pack');
            else modalBox.classList.remove('god-pack');

            // --- LÓGICA DE SELECCIÓN DE JUGADORES ---
            let pool = [];
            if (role === 'Player') {
                pool = (strict && posCode !== 'Player') ? database.filter(p => p.role === 'Player' && p.perfil.posicion === posCode) : database.filter(p => p.role === 'Player');
            } else { pool = database.filter(p => p.role === role); }

            if (role === 'Manager') pool = pool.filter(p => p.role === 'Manager');
            if (role === 'Coordinator') pool = pool.filter(p => p.role === 'Coordinator');
            if (role === 'Player') pool = pool.filter(p => p.role === 'Player');

            pool = pool.filter(p => !pickedIDs.has(p.id));
            pool = pool.filter(p => !pickedBaseNames.has(getBaseName(p.nombre)));

            let picks = [];
            let roundNames = new Set();

            const pickUnique = (sourceArr) => {
                let shuffled = [...sourceArr].sort(() => 0.5 - Math.random());
                for (let p of shuffled) {
                    let bName = getBaseName(p.nombre);
                    if (!roundNames.has(bName)) { roundNames.add(bName); return p; }
                }
                return null;
            }

            if (isSpecial) {
                // GOD PACK LOGIC
                const poolIF = pool.filter(p => calcTotal(p) >= limitIF);
                const poolGoldS = pool.filter(p => calcTotal(p) < limitIF && calcTotal(p) >= limitGoldShiny);
                const poolGold = pool.filter(p => calcTotal(p) < limitGoldShiny && calcTotal(p) >= limitGold);

                let thresholdIF = DRAFT_CONFIG.godPack.IF;

                for (let i = 0; i < 5; i++) {
                    let rand = Math.random() * 100;
                    let p = null;

                    if (rand < thresholdIF && poolIF.length > 0) p = pickUnique(poolIF);
                    else if (poolGoldS.length > 0) p = pickUnique(poolGoldS);
                    else p = pickUnique(poolGold.length > 0 ? poolGold : poolIF); // Fallback

                    if (!p) p = pickUnique(poolGoldS);
                    if (!p) p = pickUnique(poolGold);
                    if (!p) p = pickUnique(pool);
                    if (p) picks.push(p);
                }
            } else {
                // NORMAL PACK LOGIC
                const t1 = pool.filter(p => calcTotal(p) >= limitIF); // IF
                const t2 = pool.filter(p => calcTotal(p) < limitIF && calcTotal(p) >= limitGoldShiny); // GoldS
                const t3 = pool.filter(p => calcTotal(p) < limitGoldShiny && calcTotal(p) >= limitGold); // Gold
                const t4 = pool.filter(p => calcTotal(p) < limitGold && calcTotal(p) >= limitSilverShiny); // SilverS
                const t5 = pool.filter(p => calcTotal(p) < limitSilverShiny); // Silver

                // Calcular thresholds acumulativos
                let rIF = DRAFT_CONFIG.normal.IF;
                let rGS = rIF + DRAFT_CONFIG.normal.GoldShiny;
                let rG = rGS + DRAFT_CONFIG.normal.Gold;
                let rSS = rG + DRAFT_CONFIG.normal.SilverShiny;

                for (let i = 0; i < 5; i++) {
                    let rand = Math.random() * 100;
                    let p = null;

                    if (rand < rIF && t1.length > 0) p = pickUnique(t1);
                    else if (rand < rGS && t2.length > 0) p = pickUnique(t2);
                    else if (rand < rG && t3.length > 0) p = pickUnique(t3);
                    else if (rand < rSS && t4.length > 0) p = pickUnique(t4);
                    else p = pickUnique(t5.length > 0 ? t5 : pool);

                    if (!p) {
                        let all = [...pool].sort(() => 0.5 - Math.random());
                        for (let c of all) { if (!roundNames.has(getBaseName(c.nombre))) { p = c; roundNames.add(getBaseName(c.nombre)); break; } }
                    }
                    if (p) picks.push(p);
                }
            }

            // --- DETERMINAR TIPO DE SOBRE BASADO EN EL CONTENIDO ---
            let packTierClass = 'p-bronze'; // Default
            if (isSpecial) {
                packTierClass = 'p-god';
            } else {
                // Calcular media de los 5 jugadores
                const avgTotal = picks.reduce((sum, p) => sum + calcTotal(p), 0) / (picks.length || 1);

                if (avgTotal >= limitGold) packTierClass = 'p-gold';
                else if (avgTotal >= limitSilverShiny) packTierClass = 'p-silver';
                // si es menor, se queda en p-bronze
            }
            // Aplicar clase de color al sobre
            packVisual.classList.add(packTierClass);

            // --- SECUENCIA DE ANIMACIÓN (FLASH SPEED) ---
            const loadingPromises = picks.map(p => findValidPath(p.id, p.nombre).then(src => ({ ...p, imgSrc: src })));

            // Tiempo reducido a 0.6s
            setTimeout(() => { packVisual.classList.add('opening'); }, 10);
            const animationTime = new Promise(resolve => setTimeout(resolve, 600));

            const [readyPlayers] = await Promise.all([Promise.all(loadingPromises), animationTime]);

            // FLASH!
            flash.classList.add('active');

            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 100);
                renderPicks(readyPlayers, container);

                // Reactivar scroll tras mostrar
                setTimeout(() => { if (grid) grid.style.overflowX = 'auto'; }, 600);

            }, 300);
        }

        function renderPicks(players, container) {
            players.forEach((p, index) => {
                const total = calcTotal(p);
                const rareClass = getTotalColorClass(total);

                const card = document.createElement('div');
                card.className = `choice-card ${rareClass} revealed`;
                card.style.animationDelay = `${index * 0.08}s`;

                const rawElem = p.perfil ? p.perfil.elemento : "Void";
                const elemEs = translations.elem[rawElem] || rawElem;

                let statsHtml = "";
                if (p.stats) {
                    statsHtml = `<div class="stats-grid">`;
                    const statKeys = { "Tiro": "tiro", "Control": "control", "Técnica": "tecnica", "Presión": "presion", "Físico": "fisico", "Agilidad": "agilidad" };
                    for (const [label, key] of Object.entries(statKeys)) {
                        const val = p.stats[key] || 0;
                        statsHtml += `<div class="stat-item"><span>${label}</span><span>${val}</span></div>`;
                    }
                    statsHtml += `</div>`;
                }

                // --- FIX: Añadir onload y onerror ---
                card.innerHTML = `
                    <div class="choice-score ${rareClass}">${total}</div>
                    <div class="choice-img-box">
                        <img src="${p.imgSrc || ''}" 
                             class="choice-img" 
                             onload="this.classList.add('loaded')" 
                             onerror="this.src=''">
                    </div>
                    <div class="choice-info">
                        <div class="choice-name">${p.nombre}</div>
                        <div style="font-size:0.7rem; margin-bottom:2px; color:#aaa;"><span class="el-${elemEs}" style="font-weight:bold;">${elemEs}</span> • ${p.role === 'Player' ? p.perfil.posicion : 'Staff'}</div>
                        ${statsHtml}
                    </div>
                `;

                card.onclick = () => fillSlot(p, total, elemEs, rareClass, p.imgSrc);
                container.appendChild(card);
            });
        }

        function fillSlot(p, total, elemEs, rareClass, imgSrc) {
            pickedIDs.add(p.id);
            pickedBaseNames.add(getBaseName(p.nombre));

            const slot = activeSlot;
            slot.classList.add('filled');
            slot.classList.add(rareClass);

            const pos = p.perfil ? p.perfil.posicion : (p.role === 'Manager' ? 'ENT' : 'GER');

            slot.innerHTML = `
                <div class="mini-player">
                    <div class="mini-badge el-${elemEs}">${pos}</div>
                    <img src="${imgSrc || ''}" class="mini-img loaded">
                    <div class="mini-info">
                        <div class="mini-name">${p.nombre}</div>
                        <div class="mini-total">TOT: ${total}</div>
                    </div>
                </div>
            `;

            teamTotal += total; updateStats(); closeModal();

            const filledCount = document.querySelectorAll('.slot.filled').length;
            if (filledCount === 20) {
                generateReserves();
            }
        }

        function generateReserves() {
            const layout = formations[currentFormation];
            const neededPos = layout.flat();
            const container = document.getElementById('reserves-container');
            const section = document.getElementById('reserves-section');
            container.innerHTML = '';

            let reserveIDs = new Set();
            neededPos.forEach(posCode => {
                let candidates = database.filter(p =>
                    p.role === 'Player' &&
                    p.perfil.posicion === posCode &&
                    !pickedIDs.has(p.id) &&
                    !pickedBaseNames.has(getBaseName(p.nombre)) &&
                    !reserveIDs.has(p.id)
                );
                if (candidates.length === 0) candidates = database.filter(p => p.role === 'Player' && p.perfil.posicion === posCode);

                if (candidates.length > 0) {
                    const pick = candidates[Math.floor(Math.random() * candidates.length)];
                    reserveIDs.add(pick.id);
                    const div = document.createElement('div');

                    const total = calcTotal(pick);
                    const rareClass = getTotalColorClass(total);
                    div.className = `reserve-slot ${rareClass}`;

                    div.innerHTML = `
                        <div class="reserve-pos">${posCode}</div>
                        <img src="" class="reserve-img">
                        <div class="reserve-name-box"><div class="reserve-name">${pick.nombre}</div></div>
                    `;

                    const img = div.querySelector('img');
                    loadKnownImage(img, pick.id, pick.nombre);

                    container.appendChild(div);
                }
            });
            section.style.display = 'flex';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        function takeScreenshot() {
            const target = document.getElementById('main-layout');
            if (!target) return;
            const options = {
                backgroundColor: "#0a0a0a",
                scale: 1.5,
                useCORS: true,
                allowTaint: false,
                logging: false,
                width: target.scrollWidth,
                height: target.scrollHeight,
                windowWidth: target.scrollWidth,
                windowHeight: target.scrollHeight,
                x: 0, y: 0
            };
            const header = document.querySelector('header');
            if (header) header.style.display = 'none';
            window.scrollTo(0, 0);
            html2canvas(target, options).then(canvas => {
                if (header) header.style.display = 'flex';
                const link = document.createElement('a');
                link.download = `Draft_Team_${teamTotal}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error(err);
                if (header) header.style.display = 'flex';
                alert("Error al guardar imagen. Revisa consola.");
            });
        }

        function updateStats() { document.getElementById('team-power').innerText = teamTotal; }
        function calcTotal(p) { if (!p.stats) return 0; return Object.values(p.stats).reduce((a, b) => a + b, 0); }
        function closeModal() { document.getElementById('draftModal').style.display = 'none'; }
        function resetDraft() {
            if (confirm("¿Reiniciar draft?")) {
                document.getElementById('pitchBoard').innerHTML = `
                <div class="pitch-lines-container">
                    <div class="field-line-box penalty-area top"></div>
                    <div class="field-line-box penalty-area bottom"></div>
                    <div class="field-line-box goal-area top"></div>
                    <div class="field-line-box goal-area bottom"></div>
                </div>`;
                document.getElementById('benchBoard').innerHTML = "";
                document.getElementById('reserves-section').style.display = 'none';
                document.getElementById('reserves-container').innerHTML = '';
                document.getElementById('main-header').style.display = 'none';
                document.getElementById('main-layout').style.display = 'none';
                document.getElementById('config-overlay').style.display = 'flex';
                teamTotal = 0; pickedIDs.clear(); pickedBaseNames.clear();
            }
        }
    </script>
</body>

</html>